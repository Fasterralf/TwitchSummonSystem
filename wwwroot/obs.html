<!DOCTYPE html>
<html>
<head>
    <title>Twitch Summon System</title>
    <style>
        body {
            background: transparent;
            font-family: 'Arial Black', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            color: white;
            overflow: hidden;
        }

        .summon-result {
            text-align: center;
            font-size: 48px;
            font-weight: bold;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
            display: none;
            position: relative;
        }

        .gold {
            color: #FFD700;
            animation: goldPulse 0.8s ease-out;
        }

            .gold::before {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                width: 200px;
                height: 200px;
                background: radial-gradient(circle, rgba(255,215,0,0.3) 0%, transparent 70%);
                border-radius: 50%;
                transform: translate(-50%, -50%);
                animation: auraExpand 1.2s ease-out;
                z-index: -1;
            }

            .gold::after {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                width: 150px;
                height: 150px;
                border: 2px solid #FFD700;
                border-radius: 50%;
                transform: translate(-50%, -50%);
                animation: ringRotate 2s linear infinite;
                z-index: -1;
            }

        .no-gold {
            color: #888888;
            animation: noGoldFade 0.6s ease-in;
        }

        .sparkle {
            position: absolute;
            color: #FFD700;
            font-size: 20px;
            pointer-events: none;
            animation: sparkleFloat 1.5s ease-out forwards;
        }

        .stats-counter {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 20px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #6441a5;
        }

        .stat-line {
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
            min-width: 200px;
        }

        .stat-label {
            color: #ccc;
        }

        .stat-value {
            color: #FFD700;
            font-weight: bold;
        }

        @keyframes goldPulse {
            0% {
                transform: scale(0.5);
                opacity: 0;
                text-shadow: 0 0 20px #FFD700;
            }

            50% {
                transform: scale(1.2);
                text-shadow: 0 0 30px #FFD700, 0 0 40px #FFD700;
            }

            100% {
                transform: scale(1);
                opacity: 1;
                text-shadow: 3px 3px 6px rgba(0,0,0,0.8), 0 0 20px #FFD700;
            }
        }

        @keyframes auraExpand {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 1;
            }

            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0;
            }
        }

        @keyframes ringRotate {
            0% {
                transform: translate(-50%, -50%) rotate(0deg);
                opacity: 0.8;
            }

            100% {
                transform: translate(-50%, -50%) rotate(360deg);
                opacity: 0.8;
            }
        }

        @keyframes sparkleFloat {
            0% {
                transform: translateY(0) scale(0);
                opacity: 1;
            }

            50% {
                opacity: 1;
                transform: scale(1);
            }

            100% {
                transform: translateY(-50px) scale(0);
                opacity: 0;
            }
        }

        @keyframes noGoldFade {
            0% {
                opacity: 0;
                transform: translateY(10px);
            }

            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="stats-counter">
        <div class="stat-line">
            <span class="stat-label">Summons:</span>
            <span class="stat-value" id="summonCount">0</span>
        </div>
        <div class="stat-line">
            <span class="stat-label">Golds:</span>
            <span class="stat-value" id="goldCount">0</span>
        </div>
        <div class="stat-line">
            <span class="stat-label">Chance:</span>
            <span class="stat-value" id="goldChance">0.8%</span>
        </div>
        <div class="stat-line">
            <span class="stat-label">Rate:</span>
            <span class="stat-value" id="goldRate">0.0%</span>
        </div>
    </div>

    <div id="summonResult" class="summon-result">
        <div id="resultText"></div>
        <div id="username" style="font-size: 24px; margin-top: 10px;"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>
    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/summonhub")
            .build();

        connection.start().then(function () {
            console.log("SignalR verbunden");
            loadCurrentStats();
        }).catch(function (err) {
            console.error("SignalR Fehler: " + err.toString());
        });

        connection.on("SummonResult", function (result) {
            showSummonResult(result);
            setTimeout(loadCurrentStats, 1000);
        });

        connection.on("PityReset", function (lotteryData) {
            loadCurrentStats();
        });

        connection.on("LotteryUpdate", function (lotteryData) {
            updateStatsFromLotteryData(lotteryData);
        });

        function createSparkles() {
            const sparkleSymbols = ['✨', '⭐', '💫', '🌟'];
            const resultDiv = document.getElementById('summonResult');

            for (let i = 0; i < 8; i++) {
                setTimeout(() => {
                    const sparkle = document.createElement('div');
                    sparkle.className = 'sparkle';
                    sparkle.textContent = sparkleSymbols[Math.floor(Math.random() * sparkleSymbols.length)];

                    // Random position around the text
                    const angle = (i / 8) * 360 + Math.random() * 45;
                    const radius = 80 + Math.random() * 40;
                    const x = Math.cos(angle * Math.PI / 180) * radius;
                    const y = Math.sin(angle * Math.PI / 180) * radius;

                    sparkle.style.left = `calc(50% + ${x}px)`;
                    sparkle.style.top = `calc(50% + ${y}px)`;
                    sparkle.style.animationDelay = `${Math.random() * 0.5}s`;

                    resultDiv.appendChild(sparkle);

                    // Remove sparkle after animation
                    setTimeout(() => {
                        if (sparkle.parentNode) {
                            sparkle.parentNode.removeChild(sparkle);
                        }
                    }, 2000);
                }, i * 100);
            }
        }

        function showSummonResult(result) {
            const resultDiv = document.getElementById('summonResult');
            const resultText = document.getElementById('resultText');
            const username = document.getElementById('username');

            // Clear previous sparkles
            const oldSparkles = resultDiv.querySelectorAll('.sparkle');
            oldSparkles.forEach(sparkle => sparkle.remove());

            if (result.IsGold || result.isGold) {
                resultText.textContent = "⭐ GOLD! ⭐";
                resultDiv.className = "summon-result gold";

                // Create sparkle effect
                setTimeout(() => createSparkles(), 200);
            } else {
                resultText.textContent = "Kein Gold";
                resultDiv.className = "summon-result no-gold";
            }

            username.textContent = result.Username || result.username;
            resultDiv.style.display = 'block';

            setTimeout(() => {
                resultDiv.style.display = 'none';
            }, 5000);
        }

        function updateStatsFromLotteryData(lotteryData) {
            document.getElementById('summonCount').textContent = lotteryData.TotalSummons || 0;
            document.getElementById('goldCount').textContent = lotteryData.TotalGolds || 0;
            const goldRate = lotteryData.TotalSummons > 0 ?
                (lotteryData.TotalGolds / lotteryData.TotalSummons * 100) : 0;
            document.getElementById('goldRate').textContent = goldRate.toFixed(1) + '%';
            document.getElementById('goldChance').textContent = (lotteryData.CurrentGoldChance || 0.8).toFixed(1) + '%';
        }

        function loadCurrentStats() {
            fetch('/api/summon/stats')
                .then(response => response.json())
                .then(stats => {
                    document.getElementById('summonCount').textContent = stats.totalSummons || 0;
                    document.getElementById('goldCount').textContent = stats.totalGolds || 0;
                    const goldRate = stats.goldRate || 0;
                    document.getElementById('goldRate').textContent = goldRate.toFixed(1) + '%';
                    const currentChance = stats.currentGoldChance || stats.goldChance || 0.8;
                    document.getElementById('goldChance').textContent = currentChance.toFixed(1) + '%';
                    console.log(`📊 Stats geladen: ${stats.totalSummons} Summons, ${currentChance}% Chance`);
                })
                .catch(err => {
                    console.error('Fehler beim Laden der Stats:', err);
                    document.getElementById('goldChance').textContent = '0.8%';
                });
        }
    </script>
</body>
</html>
