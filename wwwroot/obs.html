<!DOCTYPE html>
<html>
<head>
    <title>Twitch Summon System</title>
    <style>
        body {
            background: transparent;
            font-family: 'Arial Black', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            color: white;
        }

        .summon-result {
            text-align: center;
            font-size: 48px;
            font-weight: bold;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
            display: none;
        }

        .gold {
            color: #FFD700;
            animation: goldGlow 1s ease-in-out infinite alternate;
        }

        .no-gold {
            color: #888888;
        }

        .stats-counter {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 20px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #6441a5;
        }

        .stat-line {
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
            min-width: 200px;
        }

        .stat-label {
            color: #ccc;
        }

        .stat-value {
            color: #FFD700;
            font-weight: bold;
        }

        @keyframes goldGlow {
            from {
                text-shadow: 3px 3px 6px rgba(255,215,0,0.8);
            }

            to {
                text-shadow: 3px 3px 20px rgba(255,215,0,1);
            }
        }
    </style>
</head>
<body>
    <div class="stats-counter">
        <div class="stat-line">
            <span class="stat-label">Summons:</span>
            <span class="stat-value" id="summonCount">0</span>
        </div>
        <div class="stat-line">
            <span class="stat-label">Golds:</span>
            <span class="stat-value" id="goldCount">0</span>
        </div>
        <div class="stat-line">
            <span class="stat-label">Chance:</span>
            <span class="stat-value" id="goldChance">0.8%</span>
        </div>
        <div class="stat-line">
            <span class="stat-label">Rate:</span>
            <span class="stat-value" id="goldRate">0.0%</span>
        </div>
    </div>

    <div id="summonResult" class="summon-result">
        <div id="resultText"></div>
        <div id="username" style="font-size: 24px; margin-top: 10px;"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>
    <script>
        // SignalR Verbindung
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/summonhub")
            .build();

        // Verbindung starten
        connection.start().then(function () {
            console.log("SignalR verbunden");
            loadCurrentStats();
        }).catch(function (err) {
            console.error("SignalR Fehler: " + err.toString());
        });

        // Summon Ergebnis empfangen
        connection.on("SummonResult", function (result) {
            showSummonResult(result);
            // Stats nach Summon aktualisieren
            setTimeout(loadCurrentStats, 1000);
        });

        // Lottery Reset empfangen
        connection.on("PityReset", function (lotteryData) {
            loadCurrentStats();
        });

        // Lottery Update empfangen
        connection.on("LotteryUpdate", function (lotteryData) {
            updateStatsFromLotteryData(lotteryData);
        });

        function showSummonResult(result) {
            const resultDiv = document.getElementById('summonResult');
            const resultText = document.getElementById('resultText');
            const username = document.getElementById('username');

            if (result.IsGold || result.isGold) {
                resultText.textContent = "⭐ GOLD! ⭐";
                resultDiv.className = "summon-result gold";
            } else {
                resultText.textContent = "Kein Gold";
                resultDiv.className = "summon-result no-gold";
            }

            username.textContent = result.Username || result.username;
            resultDiv.style.display = 'block';

            // Nach 5 Sekunden ausblenden
            setTimeout(() => {
                resultDiv.style.display = 'none';
            }, 5000);
        }

        function updateStatsFromLotteryData(lotteryData) {
            document.getElementById('summonCount').textContent = lotteryData.TotalSummons || 0;
            document.getElementById('goldCount').textContent = lotteryData.TotalGolds || 0;

            const goldRate = lotteryData.TotalSummons > 0 ?
                (lotteryData.TotalGolds / lotteryData.TotalSummons * 100) : 0;
            document.getElementById('goldRate').textContent = goldRate.toFixed(1) + '%';

            document.getElementById('goldChance').textContent = (lotteryData.CurrentGoldChance || 0.8).toFixed(1) + '%';
        }

        function loadCurrentStats() {
            fetch('/api/summon/stats')
                .then(response => response.json())
                .then(stats => {
                    document.getElementById('summonCount').textContent = stats.TotalSummons || 0;
                    document.getElementById('goldCount').textContent = stats.TotalGolds || 0;

                    const goldRate = stats.GoldRate || 0;
                    document.getElementById('goldRate').textContent = goldRate.toFixed(1) + '%';

                    const currentChance = stats.CurrentGoldChance || stats.GoldChance || 0.8;
                    document.getElementById('goldChance').textContent = currentChance.toFixed(1) + '%';
                })
                .catch(err => {
                    console.error('Fehler beim Laden der Stats:', err);
                    // Fallback Werte
                    document.getElementById('goldChance').textContent = '0.8%';
                });
        }
    </script>
</body>
</html>
